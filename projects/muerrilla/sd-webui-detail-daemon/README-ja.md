
# Detail Daemon
これは[Stable Diffusion Web UI](https://github.com/AUTOMATIC1111/stable-diffusion-webui)の拡張機能で、ユーザーがサンプリングステップ中に画像のディテールや滑らかさの量を調整できるようにします。

LORAやControlNetなどは一切使用しておらず、その結果、特定のスタイルに偏らず、生成に新たなスタイリッシュまたは意味的特徴を導入しません。つまり、どのモデルやどのタイプの画像でも動作可能です。

<sub>*モデル: SSD-1B*<br></sub>
![a close up portrait of a cyberpunk knight-1Lv-0](https://github.com/muerrilla/sd-webui-detail-daemon/assets/48160881/561c33d9-9a5d-4cfc-bee8-de9126b280c1)
*左: ディテール少なめ、中央: オリジナル、右: ディテール多め*<br>

<sub>*モデル: SD 1.5 (ファインチューニング済み)*<br></sub>
![face of a cute cat love heart symbol-Zn6-0](https://github.com/muerrilla/sd-webui-detail-daemon/assets/48160881/9fbfb39f-81fb-4951-8f32-20eab410020a)
*左: ディテール少なめ、中央: オリジナル、右: ディテール多め*<br>

## 動作原理
Detail Daemonは、カスタマイズ可能なスケジュールに従い、各サンプリングステップで元のノイズレベルを操作することで動作します。

### 理論的には
ノイズレベル（シグマ、すなわちノイズの標準偏差）は、モデルに対し各デノイズステップでどの程度のノイズを想定し除去すべきかを指示します。あるデノイズステップでのシグマ値が高いほど、そのステップでモデルはより強くノイズを除去し、逆もまた同様です。

一般的なシグマスケジュールでは、デノイズ開始時は非常に高い値から始まり、その後中盤で急速に低くなり、終了に近づくにつれて非常に低い値に落ち着きます。この曲線（タイムステップのスケジュールも関係しますが、それはまた別の話です）が、大きな特徴（低周波数）が初期のステップで定義され、終了間際には小さな特徴（高周波数）の微細な変化しか見られなくなる理由です。これについては後ほど詳述します。

さて、もし元のスケジュールよりも低い値のシグマスケジュールをモデルに渡すと、各ステップでモデルはノイズを除去する量が減り、そのステップの潜在表現はよりノイジーになります。しかしその後のステップで、モデルはこの余分なノイズを意味のある画像特徴へと変換しようとします。理論上、*控えめに行えば*より詳細な画像が得られるはずです。過度に行うと、モデルは各ステップで加えられた余分なノイズに対処できず、結果が純粋なノイズに堕ちます。つまり控えめが鍵です。

### しかし実際には
控えめでは限界があります！また、これは何だ？以下の例のように、画像にそれほど多くのディテールを加えることはできず、破綻したり全く別のものになったりします。

<sub>*SD 1.5*<br></sub>
![Modesty](https://github.com/muerrilla/sd-webui-detail-daemon/assets/48160881/2f011a28-0948-48f8-b171-350add6fdd67)
元のシグマ（左）に0.9、0.85、0.8を掛けた例<br>

<sub>*SDXL*<br></sub>
![1](https://github.com/muerrilla/sd-webui-detail-daemon/assets/48160881/eff2356e-a6dd-4a4e-9c7e-861dec7713eb)
元のシグマ（左）に0.95、0.9、0.85、0.875、0.8を掛けた例<br>

理由は以下の通りです：
1. 常にノイズを追加し続け、モデルに対処する時間を十分与えていない
2. 画像の低周波数特徴（色、構図など）が定義される初期ステップを操作している

### スケジュールの登場
「ディテール」と呼ばれるものは通常、中〜高周波数領域にあり、これはサンプリング過程の中盤〜後半のステップに対応します。したがって、初期ステップをスキップして画像の主要特徴を保持し、後期ステップでモデルに余分なノイズを有用なディテールに変換する時間を与えると、次のようになります：

![3](https://github.com/muerrilla/sd-webui-detail-daemon/assets/48160881/cd47e882-8b56-4321-8c47-c0d689562780)

さらにスケジュールを洗練し、異なるサイズのディテールに対応する特定のステップをターゲットにすることも可能です：

![4](https://github.com/muerrilla/sd-webui-detail-daemon/assets/48160881/ea5027d2-3359-4733-afb4-5ae4a1218f38)

どのステップがどの周波数範囲に対応するかは、使用しているモデル、サンプラー、プロンプト（特にプロンプト編集などを使う場合）、その他多くの要因によって異なります。また、スケジュールでできることはもっと高度で、例えばシグマを極端に低くして強い余分ノイズを加え、その後高くして余分なノイズを除去しつつ良いディテールを残すなどです。したがって、それぞれの画像やディテール調整が必要な画像に最適なスケジュールを見つけるために微調整が必要です。しかし理想的には、ここにいる理由は全ての画像の完璧なディテール調整スケジュールを何時間もかけて作り上げるためでしょう。

近いうちに、様々なシナリオに対応した具体的な例や私が考案した手法を提供します。（自分メモ：これらをWikiページに移すこと）

## インストール
SD WebUIを開く > Extensionsタブへ > Availableタブへ > Load from:をクリック > Detail Daemonを探す > Installをクリック

またはInstall from URLタブへ > このリポジトリのURLを最初のフィールドに貼り付け > Installをクリック

またはWebUIフォルダに移動し、このリポジトリをextensionsフォルダに手動でクローン：

`git clone "https://github.com/muerrilla/sd-webui-detail-daemon" extensions/sd-webui-detail-daemon`

## はじめに
インストール後、txt2imgおよびimg2imgタブで拡張機能を見つけられます。
![2024-07-08 01_43_21-011366](https://github.com/muerrilla/sd-webui-detail-daemon/assets/48160881/045574cb-465c-4991-83c4-d02f803a330b)
### スライダー：
スライダー（と1つのチェックボックス）は調整量（正の値→ディテール追加、負の値→ディテール削減）と適用されるサンプリングステップ（スケジュール）を設定します。グラフのX軸は正規化されたサンプリングステップ（0〜1）、Y軸は調整量です。あとは説明不要かと思います。ドラッグしてグラフの変化を見てください。
### 数値入力：
スライダーの最大・最小値が制限的な場合があるため、下の3つの数値入力が用意されています。
### モード：
`cond`と`uncond`モードはそれぞれの潜在表現にのみ影響し、`both`は両方に影響します（当然！）。`cond`と`uncond`は強度が低く、もう一方の潜在表現が変わらないため、初期ステップにも変化を加えやすく元の生成から大きく逸脱しにくいです。

また少し複雑なのは、`both`モードで`detail amount`が正の場合、condとuncondの両方の潜在がより詳細になります。詳細なcond潜在は生成をより詳細に押し進め、詳細なuncond潜在は逆に詳細を減らそうとします。このため、このモードでは新しい特徴やアーティファクトがより多く画像に現れます。

### コツ：
パラメータの最適な設定方法については近日中に正式なドキュメントを書きます。今のところはスライダーをいじってスケジュールの形状が画像にどう影響するかを試してください。ライブプレビューの更新周期を毎フレームか1フレームおきに設定すると、サンプリング過程の各ステップで何が起きているか、Detail Daemonの効果がどうかをはっきり見られ、理解が深まります。

## 注意事項：
- Compositional Diffusion（AND構文）には完全対応していません。特にバッチサイズ > 1やプロンプト内の負の重みがある場合、モードが`cond`または`uncond`だと問題があります。
- 少数ステップのモデル（Turbo、Lightningなど）では使用が困難または制御が非常に難しいです。追記：扱えます。
- Forgeと動作可能（`cond`と`uncond`モードは非対応）。
- AlignYourSteps、FreeUなどとは異なります。
- Haomingによる[ReSharpen Extension](https://github.com/Haoming02/sd-webui-resharpen)と似ています（目的は似ているが手法は異なる）。




---

Tranlated By [Open Ai Tx](https://github.com/OpenAiTx/OpenAiTx) | Last indexed: 2025-07-23

---