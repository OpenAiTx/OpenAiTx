<div align="right">
  <details>
    <summary >🌐 语言</summary>
    <div>
      <div align="center">
        <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=en">English</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=zh-CN">简体中文</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=zh-TW">繁體中文</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=ja">日本語</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=ko">한국어</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=hi">हिन्दी</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=th">ไทย</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=fr">Français</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=de">Deutsch</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=es">Español</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=it">Italiano</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=ru">Русский</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=pt">Português</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=nl">Nederlands</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=pl">Polski</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=ar">العربية</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=fa">فارسی</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=tr">Türkçe</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=vi">Tiếng Việt</a>
        | <a href="https://openaitx.github.io/view.html?user=miquel-espinosa&project=no-time-to-train&lang=id">Bahasa Indonesia</a>
      </div>
    </div>
  </details>
</div>

<div align="center">

# 🚀 没时间训练！  
### 无需训练的基于参考的实例分割  
[![GitHub](https://img.shields.io/badge/%E2%80%8B-No%20Time%20To%20Train-black?logo=github)](https://github.com/miquel-espinosa/no-time-to-train)
[![Website](https://img.shields.io/badge/🌐-Project%20Page-grey)](https://miquel-espinosa.github.io/no-time-to-train/)
[![arXiv](https://img.shields.io/badge/arXiv-2507.02798-b31b1b)](https://arxiv.org/abs/2507.02798)

**最新技术（Papers with Code）**

[**_SOTA 1-shot_**](https://paperswithcode.com/sota/few-shot-object-detection-on-ms-coco-1-shot?p=no-time-to-train-training-free-reference) | [![PWC](https://img.shields.io/endpoint.svg?url=https://paperswithcode.com/badge/no-time-to-train-training-free-reference/few-shot-object-detection-on-ms-coco-1-shot)](https://paperswithcode.com/sota/few-shot-object-detection-on-ms-coco-1-shot?p=no-time-to-train-training-free-reference)

[**_SOTA 10-shot_**](https://paperswithcode.com/sota/few-shot-object-detection-on-ms-coco-10-shot?p=no-time-to-train-training-free-reference) | [![PWC](https://img.shields.io/endpoint.svg?url=https://paperswithcode.com/badge/no-time-to-train-training-free-reference/few-shot-object-detection-on-ms-coco-10-shot)](https://paperswithcode.com/sota/few-shot-object-detection-on-ms-coco-10-shot?p=no-time-to-train-training-free-reference)

[**_SOTA 30-shot_**](https://paperswithcode.com/sota/few-shot-object-detection-on-ms-coco-30-shot?p=no-time-to-train-training-free-reference) | [![PWC](https://img.shields.io/endpoint.svg?url=https://paperswithcode.com/badge/no-time-to-train-training-free-reference/few-shot-object-detection-on-ms-coco-30-shot)](https://paperswithcode.com/sota/few-shot-object-detection-on-ms-coco-30-shot?p=no-time-to-train-training-free-reference)

</div>

---

> 🚨 **更新（2025年7月22日）：** 已加入自定义数据集的使用说明！
> 
> 🔔 **更新（2025年7月16日）：** 代码已更新并附带使用说明！

---

## 📋 目录

- [🎯 亮点](#-highlights)
- [📜 摘要](#-abstract)
- [🧠 架构](#-architecture)
- [🛠️ 安装说明](#️-installation-instructions)
  - [1. 克隆仓库](#1-clone-the-repository)
  - [2. 创建conda环境](#2-create-conda-environment)
  - [3. 安装SAM2和DinoV2](#3-install-sam2-and-dinov2)
  - [4. 下载数据集](#4-download-datasets)
  - [5. 下载SAM2和DinoV2模型权重](#5-download-sam2-and-dinov2-checkpoints)
- [📊 推理代码：复现Few-shot COCO 30-shot SOTA结果](#-inference-code)
  - [0. 创建参考集](#0-create-reference-set)
  - [1. 使用参考填充内存](#1-fill-memory-with-references)
  - [2. 内存库后处理](#2-post-process-memory-bank)
  - [3. 目标图像推理](#3-inference-on-target-images)
  - [结果](#results)
- [🔍 自定义数据集](#-custom-dataset)
  - [0. 准备自定义数据集 ⛵🐦](#0-prepare-a-custom-dataset)
  - [0.1 仅有bbox标注时](#01-if-only-bbox-annotations-are-available)
  - [0.2 将coco标注转为pickle文件](#02-convert-coco-annotations-to-pickle-file)
  - [1. 使用参考填充内存](#1-fill-memory-with-references)
  - [2. 内存库后处理](#2-post-process-memory-bank)
- [📚 引用](#-citation)


## 🎯 亮点
- 💡 **无需训练**：无需微调，无需提示工程——只需一张参考图像。  
- 🖼️ **基于参考**：仅用少量样本即可分割新对象。  
- 🔥 **SOTA性能**：在COCO、PASCAL VOC和跨域FSOD上超越以往无需训练的方法。

**链接：**
- 🧾 [**arXiv论文**](https://arxiv.org/abs/2507.02798)  
- 🌐 [**项目主页**](https://miquel-espinosa.github.io/no-time-to-train/)  
- 📈 [**Papers with Code**](https://paperswithcode.com/paper/no-time-to-train-training-free-reference)

## 📜 摘要

> 图像分割模型的性能历来受限于大规模标注数据的高昂获取成本。Segment Anything Model（SAM）通过可提示、语义无关的分割范式缓解了这一原始问题，但在处理新图像时仍需手动视觉提示或复杂、依赖领域的提示生成规则。为进一步减轻这种新负担，我们研究了在仅提供少量参考图像的情况下进行目标分割的任务。我们的核心见解在于利用基础模型所学到的强语义先验，来识别参考图像与目标图像之间的对应区域。我们发现，这种对应关系能够自动生成用于下游任务的实例级分割掩码，并通过多阶段、无需训练的方法实现了我们的想法，包括（1）内存库构建；（2）特征表示聚合；（3）语义感知特征匹配。实验结果显示在分割指标上有显著提升，在COCO FSOD（36.8% nAP）、PASCAL VOC Few-Shot（71.2% nAP50）上达到最新水平，并在跨域FSOD基准上（22.4% nAP）超越现有无需训练方法。

![cdfsod-results-final-comic-sans-min](https://github.com/user-attachments/assets/ab302c02-c080-4042-99fc-0e181ba8abb9)




## 🧠 架构

![training-free-architecture-comic-sans-min](https://github.com/user-attachments/assets/d84dd83a-505e-45a0-8ce3-98e1838017f9)


## 🛠️ 安装说明

### 1. 克隆此仓库

```bash
git clone https://github.com/miquel-espinosa/no-time-to-train.git
cd no-time-to-train
```
### 2. 创建 conda 环境

我们将创建一个包含所需软件包的 conda 环境。

```bash
conda env create -f environment.yml
conda activate no-time-to-train
```
### 3. 安装 SAM2 和 DinoV2

我们将从源码安装 SAM2 和 DinoV2。

```bash
pip install -e .
cd dinov2
pip install -e .
cd ..
```
### 4. 下载数据集

请下载 COCO 数据集并将其放置在 `data/coco`

### 5. 下载 SAM2 和 DinoV2 检查点

我们将下载论文中使用的确切 SAM2 检查点。
（但请注意，SAM2.1 检查点已经可用，且可能表现更好。）


```bash
mkdir -p checkpoints/dinov2
cd checkpoints
wget https://dl.fbaipublicfiles.com/segment_anything_2/072824/sam2_hiera_large.pt
cd dinov2
wget https://dl.fbaipublicfiles.com/dinov2/dinov2_vitl14/dinov2_vitl14_pretrain.pth
cd ../..
```



## 📊 推理代码

⚠️ 免责声明：这是研究代码——可能会有些混乱！

### 在少量样本 COCO 中复现 30-shot SOTA 结果

定义有用的变量并创建结果文件夹：


```bash
CONFIG=./no_time_to_train/new_exps/coco_fewshot_10shot_Sam2L.yaml
CLASS_SPLIT="few_shot_classes"
RESULTS_DIR=work_dirs/few_shot_results
SHOTS=30
SEED=33
GPUS=4

mkdir -p $RESULTS_DIR
FILENAME=few_shot_${SHOTS}shot_seed${SEED}.pkl
```
#### 0. 创建参考集


```bash
python no_time_to_train/dataset/few_shot_sampling.py \
        --n-shot $SHOTS \
        --out-path ${RESULTS_DIR}/${FILENAME} \
        --seed $SEED \
        --dataset $CLASS_SPLIT
```
#### 1. 使用引用填充内存


```bash
python run_lightening.py test --config $CONFIG \
                              --model.test_mode fill_memory \
                              --out_path ${RESULTS_DIR}/memory.ckpt \
                              --model.init_args.model_cfg.memory_bank_cfg.length $SHOTS \
                              --model.init_args.dataset_cfgs.fill_memory.memory_pkl ${RESULTS_DIR}/${FILENAME} \
                              --model.init_args.dataset_cfgs.fill_memory.memory_length $SHOTS \
                              --model.init_args.dataset_cfgs.fill_memory.class_split $CLASS_SPLIT \
                              --trainer.logger.save_dir ${RESULTS_DIR}/ \
                              --trainer.devices $GPUS
```
#### 2. 后处理内存库


```bash
python run_lightening.py test --config $CONFIG \
                              --model.test_mode postprocess_memory \
                              --model.init_args.model_cfg.memory_bank_cfg.length $SHOTS \
                              --ckpt_path ${RESULTS_DIR}/memory.ckpt \
                              --out_path ${RESULTS_DIR}/memory_postprocessed.ckpt \
                              --trainer.devices 1
```
#### 3. 对目标图像的推断


```bash
python run_lightening.py test --config $CONFIG  \
                              --ckpt_path ${RESULTS_DIR}/memory_postprocessed.ckpt \
                              --model.init_args.test_mode test \
                              --model.init_args.model_cfg.memory_bank_cfg.length $SHOTS \
                              --model.init_args.model_cfg.dataset_name $CLASS_SPLIT \
                              --model.init_args.dataset_cfgs.test.class_split $CLASS_SPLIT \
                              --trainer.logger.save_dir ${RESULTS_DIR}/ \
                              --trainer.devices $GPUS
```
如果您希望在线查看推理结果（在计算时显示），请取消注释 `no_time_to_train/models/Sam2MatchingBaseline_noAMG.py` 文件中第 1746-1749 行 [链接](https://github.com/miquel-espinosa/no-time-to-train/blob/main/no_time_to_train/models/Sam2MatchingBaseline_noAMG.py#L1746)。
根据需要调整分数阈值参数 `score_thr`，以查看更多或更少的分割实例。
图片现在将被保存在 `results_analysis/few_shot_classes/` 目录中。左侧图片显示真实标签，右侧图片显示我们无训练方法找到的分割实例。

请注意，在本例中我们使用的是 `few_shot_classes` 划分，因此，我们只应期望看到该划分中的类别被分割出来的实例（而不是 COCO 中的所有类别）。

#### 结果

在运行完验证集中的所有图片后，您应该会得到：


```
BBOX RESULTS:
  Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.368

SEGM RESULTS:
  Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.342
```
---

## 🔍 自定义数据集

我们提供了在自定义数据集上运行我们流水线的说明。标注格式始终为 COCO 格式。

> **简要说明：** 想直接了解如何在*自定义数据集*上运行完整流水线，请参考 `scripts/matching_cdfsod_pipeline.sh` 以及 CD-FSOD 数据集的示例脚本（如 `scripts/dior_fish.sh`）

### 0. 准备自定义数据集 ⛵🐦

假设我们想在自定义数据集中检测**船只**⛵ 和**鸟类**🐦。使用我们的方法需要：
- 每个类别至少有 1 张*标注*的参考图片（即 1 张船的参考图片和 1 张鸟的参考图片）
- 多张目标图片，用于寻找我们所需类别的实例。

我们已经准备了一个玩具脚本，利用 coco 图片创建一个**1-shot**设置的自定义数据集。
```bash
python scripts/make_custom_dataset.py
```
这将创建一个具有以下文件夹结构的自定义数据集：
```
data/my_custom_dataset/
    ├── annotations/
    │   ├── custom_references.json
    │   ├── custom_targets.json
    │   └── references_visualisations/
    │       ├── bird_1.jpg
    │       └── boat_1.jpg
    └── images/
        ├── 429819.jpg
        ├── 101435.jpg
        └── (all target and reference images)
```
**参考图像可视化（1-shot）：**

| 鸟类 🐦 的1-shot参考图像 | 船只 ⛵ 的1-shot参考图像 |
|:----------------------:|:-----------------------:|
| <img src="https://github.com/user-attachments/assets/e59e580d-a7db-42ac-b386-892af211fc85" alt="bird_1" width="500"/> | <img src="https://github.com/user-attachments/assets/f94ee025-ae37-4a45-9c3e-0cfe8f8cd2bc" alt="boat_1" width="500"/> |


### 0.1 如果只提供了bbox标注

我们还提供了一个脚本，利用SAM2生成实例级分割掩码。如果您仅有参考图像的边界框（bounding box）标注，这将非常有用。


```bash
# Download sam_h checkpoint. Feel free to use more recent checkpoints (note: code might need to be adapted)
wget https://dl.fbaipublicfiles.com/segment_anything/sam_vit_h_4b8939.pth -O checkpoints/sam_vit_h_4b8939.pth
# Run automatic instance segmentation from ground truth bounding boxes.
python no_time_to_train/dataset/sam_bbox_to_segm_batch.py \
    --input_json data/my_custom_dataset/annotations/custom_references.json \
    --image_dir data/my_custom_dataset/images \
    --sam_checkpoint checkpoints/sam_vit_h_4b8939.pth \
    --model_type vit_h \
    --device cuda \
    --batch_size 8 \
    --visualize
```
**参考图像及其实例级分割掩码（由 SAM2 根据 gt 边界框生成，1-shot）：**

生成的分割掩码的可视化结果保存在 `data/my_custom_dataset/annotations/custom_references_with_SAM_segm/references_visualisations/`。


| BIRD 🐦 的 1-shot 参考图像（用 SAM 自动分割） | BOAT ⛵ 的 1-shot 参考图像（用 SAM 自动分割） |
|:---------------------------------:|:----------------------------------:|
| <img src="https://github.com/user-attachments/assets/65d38dc4-1454-43cd-9600-e8efc67b3a82" alt="bird_1_with_SAM_segm" width="500"/> | <img src="https://github.com/user-attachments/assets/43a558ad-50ca-4715-8285-9aa3268843c6" alt="boat_1_with_SAM_segm" width="500"/> |


### 0.2 将 coco 标注转换为 pickle 文件


```bash
python no_time_to_train/dataset/coco_to_pkl.py \
    data/my_custom_dataset/annotations/custom_references_with_segm.json \
    data/my_custom_dataset/annotations/custom_references_with_segm.pkl \
    1
```
### 1. 用引用填充内存

首先，定义有用的变量并为结果创建一个文件夹。为了正确显示标签，类别名称应按 json 文件中出现的类别 id 顺序排列。例如，`bird` 的类别 id 是 `16`，`boat` 的类别 id 是 `9`。因此，`CAT_NAMES=boat,bird`。


```bash
DATASET_NAME=my_custom_dataset
DATASET_PATH=data/my_custom_dataset
CAT_NAMES=boat,bird
CATEGORY_NUM=2
SHOT=1
YAML_PATH=no_time_to_train/pl_configs/matching_cdfsod_template.yaml
PATH_TO_SAVE_CKPTS=./tmp_ckpts/my_custom_dataset
mkdir -p $PATH_TO_SAVE_CKPTS
```
运行步骤 1：

```bash
python run_lightening.py test --config $YAML_PATH \
    --model.test_mode fill_memory \
    --out_path $PATH_TO_SAVE_CKPTS/$DATASET_NAME\_$SHOT\_refs_memory.pth \
    --model.init_args.dataset_cfgs.fill_memory.root $DATASET_PATH/images \
    --model.init_args.dataset_cfgs.fill_memory.json_file $DATASET_PATH/annotations/custom_references_with_segm.json \
    --model.init_args.dataset_cfgs.fill_memory.memory_pkl $DATASET_PATH/annotations/custom_references_with_segm.pkl \
    --model.init_args.dataset_cfgs.fill_memory.memory_length $SHOT \
    --model.init_args.dataset_cfgs.fill_memory.cat_names $CAT_NAMES \
    --model.init_args.model_cfg.dataset_name $DATASET_NAME \
    --model.init_args.model_cfg.memory_bank_cfg.length $SHOT \
    --model.init_args.model_cfg.memory_bank_cfg.category_num $CATEGORY_NUM \
    --trainer.devices 1
```
### 2. 后处理存储库


```bash
python run_lightening.py test --config $YAML_PATH \
    --model.test_mode postprocess_memory \
    --ckpt_path $PATH_TO_SAVE_CKPTS/$DATASET_NAME\_$SHOT\_refs_memory.pth \
    --out_path $PATH_TO_SAVE_CKPTS/$DATASET_NAME\_$SHOT\_refs_memory_postprocessed.pth \
    --model.init_args.model_cfg.dataset_name $DATASET_NAME \
    --model.init_args.model_cfg.memory_bank_cfg.length $SHOT \
    --model.init_args.model_cfg.memory_bank_cfg.category_num $CATEGORY_NUM \
    --trainer.devices 1
```
### 3. 对目标图像进行推理

如果将 `ONLINE_VIS` 设置为 True，预测结果将保存在 `results_analysis/my_custom_dataset/` 并在计算时显示。请注意，开启在线可视化会大大降低运行速度。

可以自由修改分数阈值 `VIS_THR` 以查看更多或更少的分割实例。

```bash
ONLINE_VIS=True
VIS_THR=0.4
python run_lightening.py test --config $YAML_PATH \
    --model.test_mode test \
    --ckpt_path $PATH_TO_SAVE_CKPTS/$DATASET_NAME\_$SHOT\_refs_memory_postprocessed.pth \
    --model.init_args.model_cfg.dataset_name $DATASET_NAME \
    --model.init_args.model_cfg.memory_bank_cfg.length $SHOT \
    --model.init_args.model_cfg.memory_bank_cfg.category_num $CATEGORY_NUM \
    --model.init_args.model_cfg.test.imgs_path $DATASET_PATH/images \
    --model.init_args.model_cfg.test.online_vis $ONLINE_VIS \
    --model.init_args.model_cfg.test.vis_thr $VIS_THR \
    --model.init_args.dataset_cfgs.test.root $DATASET_PATH/images \
    --model.init_args.dataset_cfgs.test.json_file $DATASET_PATH/annotations/custom_targets.json \
    --model.init_args.dataset_cfgs.test.cat_names $CAT_NAMES \
    --trainer.devices 1
```
### 结果

性能指标（使用与上述命令完全相同的参数）应为：


```
BBOX RESULTS:
  Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.478

SEGM RESULTS:
  Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.458
```
可视化结果保存在 `results_analysis/my_custom_dataset/`。请注意，我们的方法适用于假阴性，即不包含任何目标类别实例的图像。

*点击图片放大 ⬇️*

| 包含船只的目标图像 ⛵（左为GT，右为预测） | 包含鸟类的目标图像 🐦（左为GT，右为预测） |
|:----------------------:|:----------------------:|
| ![000000459673](https://github.com/user-attachments/assets/678dc15a-dd3b-49d5-9287-6290da16aa6b) | ![000000407180](https://github.com/user-attachments/assets/fe306e48-af49-4d83-ac82-76fac6c456d1) |

| 同时包含船只和鸟类的目标图像 ⛵🐦（左为GT，右为预测） | 不含船只和鸟类的目标图像 🚫（左为GT，右为预测） |
|:---------------------------------:|:----------------------------------:|
| ![000000517410](https://github.com/user-attachments/assets/9849b227-7f43-43d7-81ea-58010a623ad5) | ![000000460598](https://github.com/user-attachments/assets/7587700c-e09d-4cf6-8590-3df129c2568e) |


## 📚 引用

如果您使用了本工作，请引用我们：


```bibtex
@article{espinosa2025notimetotrain,
  title={No time to train! Training-Free Reference-Based Instance Segmentation},
  author={Miguel Espinosa and Chenhongyi Yang and Linus Ericsson and Steven McDonagh and Elliot J. Crowley},
  journal={arXiv preprint arXiv:2507.02798},
  year={2025},
  primaryclass={cs.CV}
}
```


---

Tranlated By [Open Ai Tx](https://github.com/OpenAiTx/OpenAiTx) | Last indexed: 2025-07-23

---