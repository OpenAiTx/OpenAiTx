# AprilTag کتابخانه تشخیص مستقل

این یک بسته ابزار شناسایی AprilTag مبتنی بر کتابخانه pupil-apriltags است که برای تشخیص و ردیابی AprilTag در دوربین استفاده می‌شود.

<!-- این لینک‌ها را نگه دارید. ترجمه‌ها به صورت خودکار با README به‌روزرسانی خواهند شد. -->
[Deutsch](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=de) | 
[English](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=en) | 
[Español](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=es) | 
[français](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=fr) | 
[日本語](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=ja) | 
[한국어](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=ko) | 
[Português](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=pt) | 
[Русский](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=ru) | 
[中文](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=zh)

## کتابخانه‌های مورد نیاز

- Python 3.6+
- OpenCV
- NumPy
- pupil-apriltags

## نصب

1. اطمینان حاصل کنید که محیط Python نصب شده است
2. وابستگی‌های مورد نیاز را نصب کنید:

```bash
pip install opencv-python numpy pupil-apriltags
```

## روش استفاده

### استفاده پایه

```python
import cv2
from apriltag import Detector, DetectorOptions

# ایجاد آشکارساز
options = DetectorOptions(
    families="tag36h11",  # خانواده تگ
    border=1,             # اندازه حاشیه تگ
    nthreads=4,           # تعداد نخ‌ها
    quad_decimate=1.0,    # ضریب downsampling تصویر
    quad_blur=0.0,        # ضریب بلور گاوسی
    refine_edges=True     # آیا لبه‌ها به صورت دقیق اصلاح شوند یا نه
)
detector = Detector(options)

# خواندن تصویر
img = cv2.imread("test_image.jpg")
gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

# تشخیص AprilTag
detections = detector.detect(gray)

# نمایش نتایج تشخیص
for detection in detections:
    print(f"خانواده تگ: {detection.tag_family}, ID: {detection.tag_id}")
    print(f"موقعیت: {detection.center}")
    print(f"گوشه‌ها: {detection.corners}")
```

### ترسیم نتایج تشخیص

```python
import numpy as np
from apriltag import draw_detection_results

# ماتریس پارامترهای داخلی دوربین و ضرایب اعوجاج
K = np.array([[800, 0, 320], [0, 800, 240], [0, 0, 1]], dtype=np.float32)
D = np.zeros((4, 1), dtype=np.float32)

# ترسیم نتایج تشخیص
result_img = draw_detection_results(img, detections, K, D, tag_size=0.1)

# نمایش نتیجه
cv2.imshow("تشخیص AprilTag", result_img)
cv2.waitKey(0)
```

### اجرای اسکریپت تست

یک اسکریپت تست ساده ارائه شده است که می‌تواند برای بررسی قابلیت تشخیص AprilTag استفاده شود:

```bash
python test_apriltag.py
```

این کار دوربین پیش‌فرض کامپیوتر را باز کرده و به صورت زنده AprilTag را تشخیص می‌دهد. برای خروج کلید "q" را فشار دهید.

## خانواده‌های تگ پشتیبانی شده

کتابخانه pupil-apriltags از خانواده‌های تگ زیر پشتیبانی می‌کند:
- tag36h11 (پیش‌فرض)
- tag25h9
- tag16h5
- tagCircle21h7
- tagCircle49h12
- tagStandard41h12
- tagStandard52h13
- tagCustom48h12

## نکات مهم

- برای دریافت عملکرد بهتر می‌توانید پارامترهای DetectorOptions را تنظیم کنید
- برای دستگاه‌هایی با منابع سخت‌افزاری محدود، می‌توانید با افزایش مقدار پارامتر quad_decimate پیچیدگی محاسباتی را کاهش دهید
- اطمینان حاصل کنید که اندازه AprilTag استفاده شده با پارامتر tag_size در کد مطابقت داشته باشد
- ترسیم محور مختصات سه‌بعدی نیازمند پارامترهای دقیق دوربین است

## ویژگی‌ها

- پشتیبانی از تشخیص AprilTag به صورت زنده با دوربین USB
- محاسبه و نمایش وضعیت سه‌بعدی (موقعیت و جهت) تگ
- پشتیبانی از ذخیره تصاویر خام و تصاویر نشانه‌گذاری شده
- قابلیت پیکربندی و پارامترهای دوربین به صورت سفارشی
- شامل ابزار کامل کالیبراسیون دوربین
- بدون وابستگی به ROS، نسخه مستقل خالص پایتون از بسته اصلی ROS

## مراحل نصب

### 1. نصب کتابخانه C مربوط به AprilTag

کتابخانه C مربوط به AprilTag ضروری است. لطفاً مراحل زیر را دنبال کنید:

#### Ubuntu/Debian:
```bash
sudo apt-get update
sudo apt-get install -y libapriltag-dev
```

#### Windows:
کاربران ویندوز باید خودشان کتابخانه را کامپایل کرده یا فایل باینری آماده را دانلود کنند و اطمینان حاصل نمایند که `apriltag.dll` در مسیر PATH سیستم یا پوشه فعلی قرار دارد.

### 2. نصب وابستگی‌های Python

```bash
pip install -r requirements.txt  -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
pip install pupil-apriltags -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
```

## راهنمای استفاده

### شروع سریع (توصیه شده)

ساده‌ترین روش استفاده، اجرای ابزار یکپارچه است که یک منوی تعاملی برای راهنمایی شما در تمام مراحل ارائه می‌دهد:

```bash
python apriltag_tool.py
```

این ابزار گزینه‌های منویی زیر را ارائه می‌دهد:
1. تولید صفحه شطرنج کالیبراسیون
2. کالیبراسیون دوربین
3. تشخیص AprilTag
4. مشاهده مستندات راهنما

کافیست طبق راهنمای منو مراحل را دنبال کنید تا فرایند کامل شود.

### کالیبراسیون دوربین

قبل از استفاده از تشخیص AprilTag، توصیه می‌شود دوربین را کالیبره کنید تا پارامترهای دقیق دوربین را به دست آورید:

```bash
# ابتدا صفحه شطرنج کالیبراسیون را تولید کنید
python create_chessboard.py --size 9x6 --square 100 --output chessboard.png --dpi 300

# صفحه شطرنج را چاپ کرده و اندازه واقعی هر مربع را اندازه بگیرید، سپس کالیبراسیون را انجام دهید
python camera_calibration.py --size 9x6 --square 0.025 --output config/camera/HSK_200W53_1080P.yaml
```

توضیحات پارامترها:

**ابزار تولید صفحه شطرنج (create_chessboard.py):**
- `--size`: تعداد نقاط گوشه داخلی صفحه شطرنج، عرضxارتفاع (پیش‌فرض: 9x6)
- `--square`: اندازه مربع، پیکسل (پیش‌فرض: 100)
- `--output`: مسیر فایل خروجی (پیش‌فرض: chessboard.png)
- `--dpi`: DPI تصویر خروجی (پیش‌فرض: 300)، بر اندازه چاپ تأثیر می‌گذارد

**برنامه کالیبراسیون دوربین (camera_calibration.py):**
- `--size`: تعداد نقاط گوشه داخلی صفحه شطرنج، عرضxارتفاع (پیش‌فرض: 9x6)
- `--square`: اندازه مربع صفحه شطرنج، متر (پیش‌فرض: 0.025)
- `--output`: مسیر فایل خروجی (پیش‌فرض: config/camera/HSK_200W53_1080P.yaml)
- `--camera`: شماره دستگاه دوربین (پیش‌فرض: 0)
- `--width`: عرض تصویر دوربین (پیش‌فرض: 1280)
- `--height`: ارتفاع تصویر دوربین (پیش‌فرض: 720)
- `--samples`: تعداد نمونه مورد نیاز برای کالیبراسیون (پیش‌فرض: 20)
- `--preview`: پیش‌نمایش اثر تصحیح پس از پایان کالیبراسیون

فرآیند کالیبراسیون:
1. تولید و چاپ صفحه شطرنج کالیبراسیون
2. اندازه‌گیری اندازه واقعی هر مربع (به متر)
3. اجرای برنامه کالیبراسیون و قرار دادن صفحه شطرنج جلوی دوربین و جمع‌آوری نمونه‌ها از زوایای مختلف
4. برنامه به صورت خودکار صفحه شطرنج را شناسایی و نمونه‌ها را ذخیره می‌کند، همچنین می‌توانید با کلید 's' فریم فعلی را دستی ذخیره کنید
5. پس از جمع‌آوری تعداد کافی نمونه، برنامه به طور خودکار پارامترهای دوربین را محاسبه و در فایل مشخص‌شده ذخیره می‌کند

### تشخیص AprilTag

پس از اتمام کالیبراسیون، می‌توانید برنامه تشخیص AprilTag را اجرا کنید:
```bash
python apriltag_detector.py
```

### روش‌های پیشرفته

```bash
python apriltag_detector.py [مسیر فایل پیکربندی] --camera شناسه_دوربین --width عرض --height ارتفاع --camera_info فایل_پارامتر_دوربین
```

توضیح پارامترها:
- `مسیر فایل پیکربندی`: مسیر فایل پیکربندی AprilTag (پیش‌فرض: `config/vision/tags_36h11_all.json`)
- `--camera`: شناسه دستگاه دوربین (پیش‌فرض: 0)
- `--camera_info`: مسیر فایل پارامترهای داخلی دوربین (پیش‌فرض: `config/camera/HSK_200W53_1080P.yaml`)
- `--width`: عرض تصویر دریافتی دوربین (پیش‌فرض: 1280)
- `--height`: ارتفاع تصویر دریافتی دوربین (پیش‌فرض: 720)

### کنترل با صفحه کلید

- `q`: خروج از برنامه

## توضیحات فایل پیکربندی

تمام تنظیمات سیستم را می‌توانید در فایل `config/vision/table_setup.json` تنظیم کنید:

```json
{
    "AprilTagConfig": {
        "family": "tag36h11",      // خانواده تگ
        "size": 0.05,              // اندازه فیزیکی تگ (واحد: متر)
        "threads": 2,              // تعداد رشته پردازشی
        "max_hamming": 0,          // بیشینه فاصله همینگ
        "z_up": true,              // محور Z رو به بالا
        "decimate": 1.0,           // ضریب پایین‌نمونه‌گیری تصویر
        "blur": 0.8,               // ضریب بلور
        "refine_edges": 1,         // بهینه‌سازی لبه‌ها
        "debug": 0                 // فعال‌سازی حالت اشکال‌زدایی
    },

    "Camera": {
        "device_id": 0,            // شناسه دستگاه دوربین
        "width": 1280,             // وضوح عرض دوربین
        "height": 720,             // وضوح ارتفاع دوربین
        "camera_info_path": "config/camera/HSK_200W53_1080P.yaml"  // فایل پارامترهای کالیبراسیون دوربین
    },

    "Archive": {
        "enable": true,            // فعال‌سازی آرشیو داده
        "preview": true,           // نمایش پنجره پیش‌نمایش
        "save_raw": false,         // ذخیره تصویر خام
        "save_pred": false,        // ذخیره تصویر پیش‌بینی
        "path": "./data/table_tracking"  // مسیر ذخیره داده‌ها
    },

    "TableConfig": {
        "reference_tags": [0, 1, 2, 3],      // لیست شناسه تگ‌های مرجع
        "moving_tags": [4, 5, 6],            // لیست شناسه تگ‌های متحرک
        "require_initialization": true,       // نیاز به مقداردهی اولیه
        "tag_positions": {                    // موقعیت‌های از پیش تعیین شده تگ‌ها (در صورت وجود)
            "0": [0.0, 0.0, 0.0],
            "1": [0.5, 0.0, 0.0],
            "2": [0.5, 0.5, 0.0],
            "3": [0.0, 0.5, 0.0]
        }
    }
}
```

با ویرایش این فایل پیکربندی می‌توانید:
1. پارامترهای آشکارساز AprilTag را تنظیم کنید
2. پارامترهای دوربین (شناسه دستگاه، وضوح، فایل پارامتر) را مشخص کنید
3. گزینه‌های آرشیو داده را تنظیم کنید
4. شناسه تگ‌های مرجع و تگ‌های متحرک را سفارشی کنید
5. کنترل کنید که آیا مقداردهی اولیه لازم است (با قرار دادن `require_initialization` روی `false` می‌توانید این مرحله را رد کنید)
6. موقعیت‌های تگ‌های از پیش تعیین‌شده را تعریف کنید

### روش استفاده

بسیار ساده است، فقط با یک دستور می‌توانید سیستم را اجرا کنید:

```
python table_tracking.py
```

اگر نیاز به استفاده از فایل پیکربندی سفارشی دارید:

```
python table_tracking.py --config مسیر فایل پیکربندی سفارشی
```

پس از اجرای سیستم، هر زمان که مایل باشید می‌توانید با کلید 'i' فرآیند مقداردهی اولیه را دستی آغاز کنید.

## پرسش‌های متداول

1. **کتابخانه apriltag پیدا نشد**
   
   مطمئن شوید کتابخانه apriltag را به درستی نصب کرده‌اید و فایل‌های کتابخانه در سیستم قابل دسترسی هستند.

2. **دوربین باز نمی‌شود**
   
   بررسی کنید شناسه دستگاه دوربین صحیح است و دوربین توسط برنامه دیگری اشغال نشده باشد.

3. **نتایج تشخیص دقیق نیست**
   
   مطمئن شوید دوربین شما به درستی کالیبره شده و اندازه تگ در فایل پیکربندی صحیح است.


## توضیح ساختار فایل‌ها

```
apriltag_standalone/
├── apriltag.py              # کد هسته کتابخانه آشکارساز AprilTag
├── apriltag_detector.py     # برنامه اصلی آشکارسازی AprilTag
├── apriltag_tool.py         # منوی شروع ابزار یکپارچه
├── camera_calibration.py    # برنامه کالیبراسیون دوربین
├── create_chessboard.py     # ابزار تولید شطرنجی
├── configs.py               # مدیریت فایل‌های پیکربندی
├── config/                  # پوشه پیکربندی
│   ├── camera/              # پیکربندی دوربین
│   │   └── HSK_200W53_1080P.yaml  # پارامترهای دوربین
│   └── vision/              # پیکربندی بینایی
│       └── tags_36h11_all.json # پیکربندی AprilTag
├── README.md                # مستندات راهنما
└── requirements.txt         # وابستگی‌های Python
```

## توضیحات فنی

این پروژه نسخه مستقل انتقال‌یافته از بسته تشخیص AprilTag در ROS است که وابستگی به ROS را حذف کرده و فقط هسته اصلی را حفظ نموده است.
فناوری‌های اصلی استفاده‌شده:

- OpenCV: پردازش تصویر، کالیبراسیون دوربین و تخمین وضعیت
- کتابخانه C AprilTag: تشخیص تگ
- SciPy: تبدیل ماتریس چرخش و کواترنیون

## مجوز

این پروژه تحت مجوز MIT منتشر شده است

## توضیح قابلیت‌های جدید

### دنبال‌کردن چند تگ و مدیریت پوشش تگ

سیستم اکنون دارای قابلیت‌های جدید زیر است:

1. **مقداردهی اولیه با عکس‌برداری**: پس از راه‌اندازی، سیستم به طور خودکار یک بار مقداردهی اولیه انجام می‌دهد و رابطه موقعیت تگ‌ها را ثبت می‌کند، از جمله:
   - موقعیت تگ‌های مرجع ثابت (ID 0-3)
   - رابطه موقعیت نسبی بین چند تگ متحرک (پیش‌فرض ID 4,5,6)

2. **مدیریت پوشش تگ**: بعد از مقداردهی اولیه، حتی اگر برخی تگ‌ها پوشانده شوند:
   - اگر تگ مرجع پوشانده شود، سیستم با استفاده از سایر تگ‌های مرجع قابل مشاهده، موقعیت تگ پوشیده‌شده را تخمین می‌زند
   - اگر تگ متحرک پوشانده شود، سیستم با استفاده از سایر تگ‌های متحرک قابل مشاهده، موقعیت تگ متحرک پوشیده‌شده را تخمین می‌زند

3. **دنبال‌کردن چند تگ**: پشتیبانی از دنبال‌کردن همزمان چند تگ متحرک، پیش‌فرض ID 4,5,6
   - اگر موقعیت نسبی تگ‌های متحرک ثابت باشد، با مشاهده فقط یکی از آن‌ها می‌توان موقعیت بقیه را تخمین زد
   - امکان سفارشی‌سازی شناسه تگ‌های متحرک در فایل پیکربندی

### توضیح فایل پیکربندی

تمام تنظیمات سیستم را می‌توانید در فایل `config/vision/table_setup.json` انجام دهید:

```json
{
    "TableConfig": {
        "reference_tags": [0, 1, 2, 3],      // لیست شناسه تگ‌های مرجع
        "moving_tags": [4, 5, 6],            // لیست شناسه تگ‌های متحرک
        "require_initialization": true,       // نیاز به مقداردهی اولیه
        "tag_positions": {                    // موقعیت‌های از پیش تعیین شده تگ‌ها (در صورت وجود)
            "0": [0.0, 0.0, 0.0],
            "1": [0.5, 0.0, 0.0],
            "2": [0.5, 0.5, 0.0],
            "3": [0.0, 0.5, 0.0]
        }
    }
}
```

با ویرایش این فایل پیکربندی می‌توانید:
1. شناسه تگ‌های مرجع و تگ‌های متحرک را سفارشی کنید
2. کنترل کنید که آیا مقداردهی اولیه لازم است (با قرار دادن `require_initialization` روی `false` می‌توانید این مرحله را رد کنید)
3. موقعیت‌های از پیش تعیین‌شده تگ‌ها را وارد کنید

### روش استفاده

1. اجرای سیستم با پیکربندی پیش‌فرض:
   ```
   python table_tracking.py
   ```

2. اجرای سیستم با فایل پیکربندی سفارشی:
   ```
   python table_tracking.py --config مسیر فایل پیکربندی سفارشی
   ```

3. مقداردهی اولیه دستی: در حین اجرای سیستم کلید 'i' را فشار دهید

### الزامات اجرا

اطمینان حاصل کنید که همه تگ‌ها در زمان مقداردهی اولیه قابل مشاهده باشند؛ سیستم رابطه موقعیت بین تگ‌ها را ثبت می‌کند. پس از مقداردهی اولیه، حتی اگر برخی تگ‌ها پوشیده شوند، سیستم می‌تواند موقعیت همه تگ‌ها را به درستی تخمین بزند.
```

---

Tranlated By [Open Ai Tx](https://github.com/OpenAiTx/OpenAiTx) | Last indexed: 2025-06-27

---