# AprilTag независимая библиотека обнаружения

Это инструментальный пакет для распознавания AprilTag, основанный на библиотеке pupil-apriltags, предназначенный для обнаружения и отслеживания AprilTag в изображениях с камеры.

<!-- Keep these links. Translations will automatically update with the README. -->
[Deutsch](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=de) | 
[English](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=en) | 
[Español](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=es) | 
[français](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=fr) | 
[日本語](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=ja) | 
[한국어](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=ko) | 
[Português](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=pt) | 
[Русский](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=ru) | 
[中文](https://www.readme-i18n.com/HexLoom/apriltag-standalone?lang=zh)

## Зависимости

- Python 3.6+
- OpenCV
- NumPy
- pupil-apriltags

## Установка

1. Убедитесь, что у вас установлен Python
2. Установите необходимые зависимости:

```bash
pip install opencv-python numpy pupil-apriltags
```

## Применение

### Базовое использование

```python
import cv2
from apriltag import Detector, DetectorOptions

# Создание детектора
options = DetectorOptions(
    families="tag36h11",  # Семейство тегов
    border=1,             # Размер рамки тега
    nthreads=4,           # Количество потоков
    quad_decimate=1.0,    # Коэффициент субдискретизации изображения
    quad_blur=0.0,        # Коэффициент гауссового размытия
    refine_edges=True     # Уточнять ли границы
)
detector = Detector(options)

# Загрузка изображения
img = cv2.imread("test_image.jpg")
gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

# Обнаружение AprilTag
detections = detector.detect(gray)

# Вывод результатов обнаружения
for detection in detections:
    print(f"Семейство тегов: {detection.tag_family}, ID: {detection.tag_id}")
    print(f"Положение: {detection.center}")
    print(f"Углы: {detection.corners}")
```

### Отрисовка результатов обнаружения

```python
import numpy as np
from apriltag import draw_detection_results

# Матрица внутренних параметров камеры и коэффициенты дисторсии
K = np.array([[800, 0, 320], [0, 800, 240], [0, 0, 1]], dtype=np.float32)
D = np.zeros((4, 1), dtype=np.float32)

# Отрисовка результатов обнаружения
result_img = draw_detection_results(img, detections, K, D, tag_size=0.1)

# Отображение результата
cv2.imshow("AprilTag Detection", result_img)
cv2.waitKey(0)
```

### Запуск тестового скрипта

Предоставлен простой тестовый скрипт для проверки работоспособности обнаружения AprilTag:

```bash
python test_apriltag.py
```

Этот скрипт откроет камеру по умолчанию и будет в реальном времени обнаруживать AprilTag. Для выхода нажмите клавишу "q".

## Поддерживаемые семейства тегов

Библиотека pupil-apriltags поддерживает следующие семейства тегов:
- tag36h11 (по умолчанию)
- tag25h9
- tag16h5
- tagCircle21h7
- tagCircle49h12
- tagStandard41h12
- tagStandard52h13
- tagCustom48h12

## Примечания

- Для повышения производительности можно скорректировать параметры в DetectorOptions
- Для устройств с ограниченными вычислительными ресурсами рекомендуется увеличить параметр quad_decimate для снижения вычислительной сложности
- Убедитесь, что размер метки AprilTag соответствует параметру tag_size в коде
- Для отрисовки 3D-оси необходимы корректные параметры камеры

## Особенности

- Поддержка обнаружения AprilTag с USB-камеры в реальном времени
- Расчёт и отображение 3D-положения тега (позиция и ориентация)
- Поддержка сохранения исходных и размеченных изображений
- Гибкая настройка конфигурации и параметров камеры
- В комплекте полный инструмент для калибровки камеры
- Не требует ROS, полностью независимая Python-реализация на основе ROS-пакета

## Шаги установки

### 1. Установка C-библиотеки AprilTag

C-библиотека AprilTag обязательна для работы. Выполните следующие шаги для установки:

#### Ubuntu/Debian:
```bash
sudo apt-get update
sudo apt-get install -y libapriltag-dev
```

#### Windows:
Пользователям Windows потребуется самостоятельно собрать или скачать готовые бинарные файлы и убедиться, что `apriltag.dll` находится в переменной среды PATH или в текущей директории.

### 2. Установка Python-зависимостей

```bash
pip install -r requirements.txt  -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
pip install pupil-apriltags -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
```

## Инструкция по использованию

### Быстрый старт (рекомендуется)

Самый простой способ использования — запустить интегрированный инструмент, который предоставляет интерактивное меню для пошагового выполнения всех этапов:

```bash
python apriltag_tool.py
```

Этот инструмент предлагает следующие пункты меню:
1. Генерация шахматной калибровочной доски
2. Калибровка камеры
3. Обнаружение AprilTag
4. Просмотр справочной документации

Выполняйте инструкции в меню для завершения всего процесса.

### Калибровка камеры

Перед использованием обнаружения AprilTag рекомендуется откалибровать камеру для получения точных параметров:

```bash
# Сначала сгенерируйте шахматную калибровочную доску
python create_chessboard.py --size 9x6 --square 100 --output chessboard.png --dpi 300

# Распечатайте шахматную доску и измерьте реальный размер клетки, затем выполните калибровку
python camera_calibration.py --size 9x6 --square 0.025 --output config/camera/HSK_200W53_1080P.yaml
```

Описание параметров:

**Утилита генерации шахматной доски (create_chessboard.py):**
- `--size`: Количество внутренних углов шахматной доски, ширина x высота (по умолчанию: 9x6)
- `--square`: Размер клетки в пикселях (по умолчанию: 100)
- `--output`: Путь к выходному файлу (по умолчанию: chessboard.png)
- `--dpi`: DPI выходного изображения (по умолчанию: 300), влияет на размер при печати

**Программа калибровки камеры (camera_calibration.py):**
- `--size`: Количество внутренних углов шахматной доски, ширина x высота (по умолчанию: 9x6)
- `--square`: Размер клетки шахматной доски в метрах (по умолчанию: 0.025)
- `--output`: Путь к выходному файлу (по умолчанию: config/camera/HSK_200W53_1080P.yaml)
- `--camera`: ID устройства камеры (по умолчанию: 0)
- `--width`: Ширина захвата с камеры (по умолчанию: 1280)
- `--height`: Высота захвата с камеры (по умолчанию: 720)
- `--samples`: Количество необходимых образцов для калибровки (по умолчанию: 20)
- `--preview`: Просмотр результатов коррекции после калибровки

Процесс калибровки:
1. Сгенерируйте и распечатайте шахматную калибровочную доску
2. Измерьте реальный размер клетки (в метрах)
3. Запустите программу калибровки, разместите доску перед камерой, соберите образцы с разных ракурсов
4. Программа автоматически распознаёт шахматную доску и собирает образцы, можно вручную сохранить кадр нажатием клавиши 's'
5. После сбора необходимого количества образцов программа рассчитает параметры камеры и сохранит их в указанный файл

### Обнаружение AprilTag

После завершения калибровки можно запустить программу обнаружения AprilTag:
```bash
python apriltag_detector.py
```

### Продвинутое использование

```bash
python apriltag_detector.py [путь к конфигурационному файлу] --camera ID_камеры --width ширина --height высота --camera_info файл_параметров_камеры
```

Описание параметров:
- `путь к конфигурационному файлу`: путь к файлу конфигурации AprilTag (по умолчанию: `config/vision/tags_36h11_all.json`)
- `--camera`: ID устройства камеры (по умолчанию: 0)
- `--camera_info`: путь к файлу внутренних параметров камеры (по умолчанию: `config/camera/HSK_200W53_1080P.yaml`)
- `--width`: ширина захвата камеры (по умолчанию: 1280)
- `--height`: высота захвата камеры (по умолчанию: 720)

### Управление с клавиатуры

- `q`: выход из программы

## Описание конфигурационного файла

Все параметры системы можно настроить в файле `config/vision/table_setup.json`:

```json
{
    "AprilTagConfig": {
        "family": "tag36h11",      // Семейство тегов
        "size": 0.05,              // Физический размер тега (в метрах)
        "threads": 2,              // Количество потоков обработки
        "max_hamming": 0,          // Максимальное расстояние Хэмминга
        "z_up": true,              // Ось Z направлена вверх
        "decimate": 1.0,           // Коэффициент субдискретизации изображения
        "blur": 0.8,               // Коэффициент размытия
        "refine_edges": 1,         // Точная обработка краев
        "debug": 0                 // Включение режима отладки
    },

    "Camera": {
        "device_id": 0,            // ID устройства камеры
        "width": 1280,             // Разрешение по ширине
        "height": 720,             // Разрешение по высоте
        "camera_info_path": "config/camera/HSK_200W53_1080P.yaml"  // Файл параметров калибровки камеры
    },

    "Archive": {
        "enable": true,            // Включить архивирование данных
        "preview": true,           // Показать окно предварительного просмотра
        "save_raw": false,         // Сохранять исходные изображения
        "save_pred": false,        // Сохранять предсказанные изображения
        "path": "./data/table_tracking"  // Путь для сохранения данных
    },

    "TableConfig": {
        "reference_tags": [0, 1, 2, 3],      // Список ID опорных тегов
        "moving_tags": [4, 5, 6],            // Список ID подвижных тегов
        "require_initialization": true,       // Требуется ли инициализация
        "tag_positions": {                    // Предустановленные позиции тегов (если есть)
            "0": [0.0, 0.0, 0.0],
            "1": [0.5, 0.0, 0.0],
            "2": [0.5, 0.5, 0.0],
            "3": [0.0, 0.5, 0.0]
        }
    }
}
```

Изменяя конфигурационный файл, вы можете:
1. Настроить параметры детектора AprilTag
2. Задать параметры камеры (ID устройства, разрешение, файл параметров)
3. Настроить параметры архивирования данных
4. Задать ID опорных и подвижных тегов
5. Контролировать необходимость инициализации (установите `require_initialization` в `false`, чтобы пропустить инициализацию)
6. Указать предустановленные позиции тегов

### Как использовать

Очень просто, для запуска системы достаточно одной команды:

```
python table_tracking.py
```

Если требуется использовать свой конфигурационный файл:

```
python table_tracking.py --config путь_к_конфигу
```

После запуска системы можно в любой момент вручную инициировать процесс инициализации, нажав клавишу 'i'.

## Часто задаваемые вопросы

1. **Не найден модуль apriltag**
   
   Убедитесь, что библиотека apriltag установлена и файл библиотеки доступен системе.

2. **Не удаётся открыть камеру**
   
   Проверьте корректность ID устройства камеры и убедитесь, что камера не занята другим приложением.

3. **Некорректные результаты обнаружения**
   
   Проверьте, что ваша камера откалибрована, а размер тега в конфигурационном файле задан правильно.


## Описание структуры файлов

```
apriltag_standalone/
├── apriltag.py              # Основной код библиотеки обнаружения AprilTag
├── apriltag_detector.py     # Главная программа обнаружения AprilTag
├── apriltag_tool.py         # Меню запуска инструментов
├── camera_calibration.py    # Программа калибровки камеры
├── create_chessboard.py     # Генератор шахматных досок
├── configs.py               # Работа с конфигурационными файлами
├── config/                  # Каталог конфигураций
│   ├── camera/              # Конфигурации камеры
│   │   └── HSK_200W53_1080P.yaml  # Параметры камеры
│   └── vision/              # Конфигурации зрения
│       └── tags_36h11_all.json # Конфигурация AprilTag
├── README.md                # Документация
└── requirements.txt         # Зависимости Python
```

## Техническое описание

Этот проект — независимая версия, перенесённая из ROS-пакета AprilTag-детекции, без зависимостей от ROS, с сохранением основной функциональности.
Используются следующие технологии:

- OpenCV: обработка изображений, калибровка камеры, оценка позы
- AprilTag C-библиотека: обнаружение тегов
- SciPy: преобразования вращения и кватернионы

## Лицензия

Данный проект распространяется под лицензией MIT

## Описание новых возможностей

### Мульти-трек и обработка перекрытий

Система теперь поддерживает следующие новые функции:

1. **Фотографическая инициализация**: После запуска система автоматически производит инициализацию с фиксацией взаимного положения тегов, включая:
   - Положение фиксированных опорных тегов (ID 0–3)
   - Взаимное положение нескольких подвижных тегов (по умолчанию ID 4,5,6)

2. **Обработка перекрытий**: После инициализации, даже если некоторые теги перекрыты:
   - Если опорные теги перекрыты, система может использовать другие видимые опорные теги для оценки положения перекрытых тегов
   - Если подвижные теги перекрыты, система может оценить положение перекрытых тегов по видимым подвижным тегам

3. **Мульти-трекинг тегов**: Поддерживается одновременное отслеживание нескольких подвижных тегов, по умолчанию ID 4,5,6
   - Если относительное положение подвижных тегов фиксировано, то при видимости хотя бы одного тега возможно оценить положение остальных
   - ID подвижных тегов можно изменить в конфигурационном файле

### Описание конфигурационного файла

Все параметры системы можно настроить в файле `config/vision/table_setup.json`:

```json
{
    "TableConfig": {
        "reference_tags": [0, 1, 2, 3],      // Список ID опорных тегов
        "moving_tags": [4, 5, 6],            // Список ID подвижных тегов
        "require_initialization": true,       // Требуется ли инициализация
        "tag_positions": {                    // Предустановленные позиции тегов (если есть)
            "0": [0.0, 0.0, 0.0],
            "1": [0.5, 0.0, 0.0],
            "2": [0.5, 0.5, 0.0],
            "3": [0.0, 0.5, 0.0]
        }
    }
}
```

Изменяя конфигурационный файл, вы можете:
1. Указать свои ID опорных и подвижных тегов
2. Контролировать необходимость инициализации (установите `require_initialization` в `false`, чтобы пропустить инициализацию)
3. Указать предустановленные позиции тегов

### Как использовать

1. Запуск системы с конфигурацией по умолчанию:
   ```
   python table_tracking.py
   ```

2. Запуск системы с собственным конфигом:
   ```
   python table_tracking.py --config путь_к_конфигу
   ```

3. Ручная инициализация: во время работы системы нажмите клавишу 'i'

### Требования к запуску

Убедитесь, что при инициализации все теги видимы — система зафиксирует их взаимное положение. После инициализации, даже если часть тегов перекрыта, система сможет корректно оценивать положение всех тегов.
```

---

Tranlated By [Open Ai Tx](https://github.com/OpenAiTx/OpenAiTx) | Last indexed: 2025-06-27

---