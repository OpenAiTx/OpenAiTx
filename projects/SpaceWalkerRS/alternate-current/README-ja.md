# 交互電流

交互電流は効率的で位置依存しないレッドストーンダストの実装です。主な焦点は、パワー計算を最適化し、発生する形状およびブロック更新の数を減らすことでレッドストーンダストによるラグを削減することにあります。これらの変更の副次効果として、レッドストーンダストネットワークのブロック更新の順序が位置依存的で混沌としたものではなく、予測可能で直感的になります。

## パフォーマンス

交互電流を使用すると、レッドストーンダストによるMSPT（1ティックあたりのミリ秒）への寄与は最大で20倍低減され、それでいて高いバニラ互換性を維持します。コードの変更箇所が少ないため侵襲性が低く、バニラのレッドストーンダストの簡単な置き換えとして利用できます。

## どのように動作するのか？

交互電流が使用するアルゴリズムは以下の目標を念頭に設計されています：
1. ワイヤーが周囲をチェックしてパワーレベルを決定する回数を最小限にすること。
2. 発生するブロックおよび形状の更新の数を最小限にすること。
3. ブロックおよび形状の更新を決定論的かつ位置依存しない順序で発生させ、バグMC-11193を修正すること。

バニラのレッドストーンワイヤーは1と2の点で失敗しているためラグが発生します。

レッドストーンワイヤーは再帰的に更新され、各ワイヤーは自分が属するネットワークの文脈ではなく単独でパワーレベルを計算します。つまり、グリッド内のワイヤーは最終値に落ち着くまでに半ダース以上もパワーレベルを変化させることがあります。この問題は1.13以下ではさらに悪化しており、ワイヤーは一度にパワーレベルを1だけ減少させていました。

これに加えて、ワイヤーはパワーレベルが変化するたびに42回のブロック更新と最大22回の形状更新を発生させます。

42回のブロック更新のうち6回は自身に対するものであり、これらは冗長なだけでなく、ワイヤーが不要にパワーレベルの再計算を行う原因となる大きなラグ源です。ブロックはマンハッタン距離2以内に24個の隣接ブロックを持つため、残りの36回のうち12回は重複した更新であり、これも冗長です。

22回の形状更新のうち、厳密に必要なものは6回だけです。残りの16回は対角線上の上下のブロックに送られます。これはワイヤーが接続を変化させた場合には必要ですが、パワーレベルを変えた場合には不要です。

バニラのレッドストーンワイヤーはまた3の点でも失敗していますが、これはラグの問題よりも利便性の問題です。更新が再帰的に行われることと、各ワイヤーが隣接ワイヤーを更新する順序が位置依存であるため、ワイヤーネットワークの隣接ブロックの更新順序が非常に不整合でランダムに見えます。

交互電流はこれらの問題を以下のように修正します。

(1)
ワイヤーがパワーレベルを計算する回数を可能な限り減らすために、バニラでの再帰的更新を取り除きます。その代わりに接続されたワイヤーのネットワークを構築し、「外部」からレッドストーンパワーを受け取るワイヤーを見つけて、そこからパワーを広げます。これにはいくつかの利点があります：

- 各ワイヤーは非ワイヤーコンポーネントからのパワーを多くても1回、近隣ワイヤーからは2回だけチェックします。
- 各ワイヤーは世界に対してパワーレベルを1回だけ設定します。これは重要で、Level.setBlockの呼び出しはLevel.getBlockStateよりもさらにコストが高いためです。

(2)
ブロック更新および形状更新の数を減らす明らかな方法が2つあります。

- 18回の冗長なブロック更新と16回の冗長な形状更新を削除し、パワーレベルが変わるたびに各ワイヤーが24回のブロック更新と6回の形状更新のみを発生させる。
- ワイヤーが最終的なパワーレベルに達したときにのみブロック更新および形状更新を発生させ、中間の段階では発生させない。
個々のワイヤーに関しては、これら二つの最適化が最良ですが、ネットワーク全体に対してはさらに良い方法があります！

ネットワーク全体の電力を計算しているため、その中のワイヤーへのブロックおよび形状の更新を送信するのは冗長です。これらの更新を削除することで、ブロックおよび形状の更新回数を最大20％削減できます。

(3)
ネットワークの隣接するブロックの更新順序を決定的にするために、最初に行うべきはワイヤーが隣接ブロックを更新する際の位置依存の順序を置き換えることです。代わりに、電力の流れる方向に基づいて順序を決定します。このアルゴリズムの一部は、theosibの「RedstoneWireTurbo」から大きな影響を受けています。詳細はMojiraのtheosibのコメント[こちら](https://bugs.mojang.com/browse/MC-81098?focusedCommentId=420777&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-420777)や、carpet modの実装[こちら](https://github.com/gnembon/fabric-carpet/blob/master/src/main/java/carpet/helpers/RedstoneWireTurbo.java)をご覧ください。

この考え方は、隣接するワイヤーから受け取る電力に基づいて、ワイヤーを流れる電力の方向を決定することです。例えば、ワイヤーが受け取る唯一の電力が西側の隣接ワイヤーからの場合、そのワイヤーを流れる電力の方向は東向きと見なせます。

ワイヤーの隣接ブロックの更新順序を、電力の流れる方向に基づいて決定します。これにより位置依存性が完全に除去され、多くの場合で方向依存性も取り除かれます。ただし「RedstoneWireTurbo」とは異なり、曖昧な場合にはランダム性を導入するのではなく、私は方向性の要素を保持することにしましたが、これは簡単に変更可能です。

この変更は個々のワイヤーのブロック更新順序を修正しますが、ネットワーク全体のブロック更新順序にも対処する必要があります。これは以前の変更のおかげで簡単に解決できます：ネットワーク内で外部から電力を受け取るワイヤーを探索し、そこから電力を伝播させます。各ワイヤーが電力の流れる方向に依存した順序で隣接ワイヤーに電力を伝達すれば、位置依存せず、かつ大部分で方向依存性のないワイヤー更新順序が得られます。



---

Tranlated By [Open Ai Tx](https://github.com/OpenAiTx/OpenAiTx) | Last indexed: 2025-09-27

---