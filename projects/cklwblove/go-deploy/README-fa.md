# Go-Deploy 部署工具

یک ابزار استقرار خودکار مبتنی بر زبان Go که از طریق پروتکل SFTP امکان بارگذاری محصولات ساخته‌شده محلی به سرور راه دور را فراهم می‌کند.

## ویژگی‌های اصلی

- ✅ **انتقال ایمن**: استفاده از پروتکل SFTP، انتقال رمزگذاری‌شده مبتنی بر SSH
- ✅ **همگام‌سازی دایرکتوری**: بارگذاری بازگشتی کل ساختار دایرکتوری، حفظ لایه‌بندی فایل‌ها
- ✅ **ایجاد هوشمند**: ایجاد خودکار ساختار دایرکتوری در سرور راه دور
- ✅ **سازگاری مسیر**: محاسبه خودکار مسیر محلی بر اساس محل فایل اجرایی، بدون نگرانی از مسیر اجرای برنامه
- ✅ **پشتیبانی از فایل پیکربندی**: پشتیبانی از فایل پیکربندی JSON، مدیریت آسان تنظیمات محیط‌های مختلف
- ✅ **حذف فایل**: پشتیبانی از الگوی wildcard برای حذف فایل‌های غیرضروری از بارگذاری
- ✅ **پشتیبان‌گیری خودکار**: امکان پشتیبان‌گیری خودکار از فایل‌های سرور قبل از بارگذاری
- ✅ **مکانیزم تلاش مجدد**: تلاش مجدد خودکار هنگام شکست بارگذاری، افزایش احتمال موفقیت
- ✅ **آمار دقیق**: نمایش تعداد فایل‌های بارگذاری‌شده، حجم انتقال، مدت زمان و سرعت
- ✅ **نمایش پیشرفت**: نمایش پیشرفت و اطلاعات فایل‌ها به صورت لحظه‌ای
- ✅ **مدیریت خطا**: مدیریت خطای کامل و خروجی لاگ مناسب

## الزامات سیستم

- Go نسخه 1.18 یا بالاتر
- سرور هدف باید از پروتکل SSH/SFTP پشتیبانی کند

## راهنمای نصب

### 1. کلون کردن پروژه

```bash
git clone <your-repo-url>
cd go-deploy
```

### 2. مقداردهی اولیه ماژول Go

```bash
go mod init go-deploy
go mod tidy
```

### 3. نصب وابستگی‌ها

برنامه به طور خودکار وابستگی‌های زیر را دانلود خواهد کرد:

- `github.com/pkg/sftp` - کلاینت SFTP
- `golang.org/x/crypto/ssh` - کلاینت SSH

## راهنمای پیکربندی

برنامه از دو روش پیکربندی پشتیبانی می‌کند:

### 1. استفاده از فایل پیکربندی (توصیه‌شده)

فایل `config.example.json` را به `config.json` کپی کرده و مقادیر آن را ویرایش نمایید:

```bash
cp config.example.json config.json
```

سپس فایل `config.json` را ویرایش کنید:

```json
{
  "server": {
    "host": "your-server-ip",
    "port": 22,
    "username": "your-username",
    "password": "your-password",
    "timeout": 10
  },
  "paths": {
    "local": "../../unpackage/dist/build/web",
    "remote": "/opt/your-path/dist"
  },
  "options": {
    "backup": true,
    "backup_suffix": ".backup",
    "exclude_patterns": [
      "*.log",
      "*.map",
      ".DS_Store",
      "node_modules"
    ],
    "max_retries": 3,
    "chunk_size": 1048576
  }
}
```

#### توضیح گزینه‌های پیکربندی

**پیکربندی server:**

- `host`: آدرس سرور SSH
- `port`: پورت SSH، معمولاً ۲۲
- `username`: نام کاربری SSH
- `password`: رمز عبور SSH (در محیط تولید پیشنهاد می‌شود از احراز هویت کلید استفاده شود)
- `timeout`: زمان انتظار اتصال (ثانیه)

**پیکربندی paths:**

- `local`: مسیر دایرکتوری محلی، پشتیبانی از مسیر نسبی و مطلق
- `remote`: مسیر دایرکتوری راه دور، باید مطلق باشد

**پیکربندی options:**

- `backup`: آیا قبل از بارگذاری از فایل‌های موجود در سرور پشتیبان تهیه شود یا خیر
- `backup_suffix`: پسوند فایل پشتیبان، قابل سفارشی‌سازی؛ اگر فایل پشتیبان وجود نداشته باشد، از این مرحله عبور می‌شود
- `exclude_patterns`: الگوی حذف فایل، پشتیبانی از wildcard
- `max_retries`: حداکثر تعداد تلاش مجدد هنگام شکست بارگذاری
- `chunk_size`: اندازه بلوک انتقال فایل (بایت، فعلاً پیاده‌سازی نشده)

### 2. پیکربندی پیش‌فرض (حالت سازگاری)

اگر فایل `config.json` وجود نداشته باشد، برنامه از پیکربندی پیش‌فرض داخلی استفاده خواهد کرد و سازگاری به عقب را حفظ می‌کند.

#### اولویت فایل پیکربندی

1. **فایل پیکربندی مشخص‌شده در خط فرمان**: فایلی که با پارامتر `--config` مشخص می‌شود
2. **فایل پیکربندی پیش‌فرض**: فایل `config.json` در دایرکتوری جاری
3. **پیکربندی پیش‌فرض داخلی**: اگر هیچ‌کدام وجود نداشت، از تنظیمات داخلی برنامه استفاده می‌شود

#### قوانین پردازش مسیرها

- **مسیر فایل پیکربندی:**
  - مسیر نسبی: نسبت به دایرکتوری محل فایل اجرایی محاسبه می‌شود
  - مسیر مطلق: مستقیماً استفاده می‌شود
- **مسیر دایرکتوری محلی:**
  - مسیر نسبی: نسبت به دایرکتوری محل فایل اجرایی محاسبه می‌شود
  - مسیر مطلق: مستقیماً استفاده می‌شود

## راهنمای اجرا

### پارامترهای خط فرمان

برنامه از پارامترهای زیر پشتیبانی می‌کند:

```bash
# نمایش راهنما
./deploy --help

# نمایش نسخه  
./deploy --version

# استفاده از فایل پیکربندی پیش‌فرض config.json
./deploy

# استفاده از فایل پیکربندی مشخص‌شده
./deploy --config prod.json

# استفاده از فایل پیکربندی با مسیر مطلق
./deploy --config /path/to/config.json
```

### اجرای محیط توسعه

```bash
# استفاده از پیکربندی پیش‌فرض
go run main.go

# استفاده از فایل پیکربندی مشخص‌شده
go run main.go --config test.json

# نمایش راهنما
go run main.go --help
```

### اجرای برنامه پس از کامپایل

```bash
# کامپایل
go build -o deploy main.go

# اجرای برنامه با پیکربندی پیش‌فرض
./deploy

# اجرای برنامه با فایل پیکربندی مشخص‌شده
./deploy --config prod.json
```

## راهنمای بسته‌بندی

### 1. بسته‌بندی برای پلتفرم محلی

```bash
# کامپایل فایل اجرایی برای پلتفرم فعلی
go build -o deploy main.go
```

### 2. بسته‌بندی چندسکویی

#### لینوکس ۶۴ بیتی

```bash
GOOS=linux GOARCH=amd64 go build -o deploy-linux-amd64 main.go
```

#### ویندوز ۶۴ بیتی
```bash
GOOS=windows GOARCH=amd64 go build -o deploy-windows-amd64.exe main.go
```

#### macOS نسخه ۶۴ بیتی

```bash
GOOS=darwin GOARCH=amd64 go build -o deploy-darwin-amd64 main.go
```

#### macOS ARM64 (M1/M2)

```bash
GOOS=darwin GOARCH=arm64 go build -o deploy-darwin-arm64 main.go
```

### ۳. بهینه‌سازی بسته‌بندی (کاهش حجم فایل)

```bash
# حذف اطلاعات دیباگ و جدول نمادها
go build -ldflags="-s -w" -o deploy main.go

# فشرده‌سازی با UPX (نیاز به نصب UPX دارد)
upx --best deploy
```

### ۴. اسکریپت بسته‌بندی دسته‌ای

ساخت اسکریپت `build.sh`:

```bash
#!/bin/bash

# ایجاد دایرکتوری ساخت
mkdir -p builds

# ساخت نسخه‌های هر پلتفرم
echo "در حال ساخت نسخه ۶۴ بیتی Linux ..."
GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o builds/deploy-linux-amd64 main.go

echo "در حال ساخت نسخه ۶۴ بیتی Windows ..."
GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o builds/deploy-windows-amd64.exe main.go

echo "در حال ساخت نسخه ۶۴ بیتی macOS ..."
GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o builds/deploy-darwin-amd64 main.go

echo "در حال ساخت نسخه ARM64 macOS ..."
GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o builds/deploy-darwin-arm64 main.go

echo "ساخت به پایان رسید!"
ls -la builds/
```

اجرای اسکریپت:

```bash
chmod +x build.sh
./build.sh
```

## نمونه استفاده

### نمایش اطلاعات راهنما

```bash
$ ./deploy --help
ابزار استقرار Go-Deploy

نحوه استفاده: ./deploy [گزینه‌ها]

گزینه‌ها:
  -config string
        مسیر فایل پیکربندی (پیش‌فرض "config.json")
  -help
        نمایش اطلاعات راهنما
  -version
        نمایش اطلاعات نسخه

مثال‌ها:
  ./deploy                           # استفاده از فایل پیکربندی پیش‌فرض config.json
  ./deploy --config prod.json        # استفاده از فایل پیکربندی مشخص شده
  ./deploy --config /path/to/config.json  # استفاده از فایل پیکربندی با مسیر مطلق
```

### استفاده از فایل پیکربندی مشخص

```bash
$ ./deploy --config prod.json
شروع اجرای برنامه استقرار...
در حال تلاش برای خواندن فایل پیکربندی: /path/to/go-deploy/prod.json
در حال استفاده از فایل پیکربندی...
دایرکتوری محلی /path/to/project/dist وجود دارد
در حال اتصال به سرور SSH...
اتصال به سرور SSH موفقیت‌آمیز بود
...
```

### استفاده از فایل پیکربندی

```bash
$ ./deploy
شروع اجرای برنامه استقرار...
در حال تلاش برای خواندن فایل پیکربندی: /path/to/go-deploy/config.json
در حال استفاده از فایل پیکربندی...
دایرکتوری محلی /path/to/project/unpackage/dist/build/web وجود دارد
در حال اتصال به سرور SSH...
اتصال به سرور SSH موفقیت‌آمیز بود
در حال ایجاد کلاینت SFTP...
کلاینت SFTP با موفقیت ایجاد شد
آماده‌سازی برای آپلود به دایرکتوری راه دور: /opt/xsoft/nginx/html/app/dist
شروع آپلود دایرکتوری...
شروع پیمایش دایرکتوری محلی: /path/to/project/unpackage/dist/build/web
ایجاد دایرکتوری: /opt/xsoft/nginx/html/app/dist
فایل static/js/app.js.map مستثنی شد، آپلود نمی‌شود
ایجاد نسخه پشتیبان: /opt/xsoft/nginx/html/app/dist/index.html -> /opt/xsoft/nginx/html/app/dist/index.html.backup
آپلود فایل: /path/to/project/unpackage/dist/build/web/index.html -> /opt/xsoft/nginx/html/app/dist/index.html
فایل .DS_Store مستثنی شد، آپلود نمی‌شود
آپلود فایل: /path/to/project/unpackage/dist/build/web/static/css/app.css -> /opt/xsoft/nginx/html/app/dist/static/css/app.css
آپلود ناموفق بود (تلاش ۱/۳): خطای شبکه
تلاش مجدد برای آپلود فایل (۲/۳): /path/to/project/unpackage/dist/build/web/static/js/app.js
آپلود فایل: /path/to/project/unpackage/dist/build/web/static/js/app.js -> /opt/xsoft/nginx/html/app/dist/static/js/app.js
...
آپلود دایرکتوری با موفقیت انجام شد!
آمار:
  - تعداد فایل‌های آپلود شده: ۴۸۵
  - تعداد دایرکتوری‌های ایجاد شده: ۱۸
  - حجم انتقال یافته: ۲۵.۸ مگابایت
  - مدت زمان آپلود: ۳۸.۵ ثانیه
  - کل مدت زمان: ۳۹.۲ ثانیه
  - سرعت انتقال: ۰.۶۷ مگابایت بر ثانیه
```

## نکات مهم

1. **امنیت**:

   - در محیط تولید توصیه می‌شود از احراز هویت کلید SSH به جای رمز عبور استفاده شود
   - در حال حاضر از `ssh.InsecureIgnoreHostKey()` استفاده می‌شود، در محیط تولید باید کلید میزبان تأیید شود
2. **شبکه**:

   - اطمینان حاصل کنید که سیستم محلی به پورت ۲۲ سرور هدف دسترسی دارد
   - سرعت انتقال وابسته به پهنای باند شبکه و عملکرد سرور است
3. **دسترسی‌ها**:

   - اطمینان حاصل کنید که کاربر SSH اجازه نوشتن در دایرکتوری هدف را دارد
   - در صورت نیاز ممکن است لازم باشد از دسترسی sudo استفاده شود
4. **مسیرها**:

   - مسیر محلی به طور خودکار بر اساس مکان فایل اجرایی محاسبه می‌شود و نیازی به نگرانی درباره دایرکتوری اجرا نیست
   - مسیر راه دور باید مطلق باشد

## رفع مشکلات

### مشکلات رایج

1. **اتصال تایم‌اوت شد**

   ```
   اتصال به سرور SSH ناموفق بود: dial tcp: i/o timeout
   ```

   - آدرس و پورت سرور را بررسی کنید
   - از اتصال شبکه مطمئن شوید
   - تنظیمات فایروال را بررسی کنید
2. **احراز هویت ناموفق**

   ```
   ورود ناموفق: ssh: handshake failed
   ```

   - نام کاربری و رمز عبور را بررسی کنید
   - اطمینان حاصل کنید سرویس SSH فعال است
   - پیکربندی SSH را بررسی کنید
3. **خطای دسترسی**

   ```
   ایجاد دایرکتوری ناموفق: permission denied
   ```

   - دسترسی کاربر به دایرکتوری هدف را بررسی کنید
   - ممکن است نیاز به استفاده از sudo یا تغییر مالکیت دایرکتوری باشد
4. **دایرکتوری محلی وجود ندارد**

   ```
   خطا: دایرکتوری محلی /path/to/unpackage/dist/build/web وجود ندارد
   ```

   - از اتمام ساخت محلی اطمینان حاصل کنید
   - ساختار دایرکتوری پروژه را بررسی کنید
   - مسیر به طور خودکار محاسبه می‌شود و نیازی به تنظیم دستی دایرکتوری کاری نیست

## توضیحات توسعه

### ساختار پروژه

```
go-deploy/
├── main.go                 # فایل اصلی برنامه
├── go.mod                  # فایل ماژول Go  
├── go.sum                  # فایل اعتبارسنجی وابستگی‌ها
```
├── README.md               # مستندات توضیحی کامل  
├── Makefile                # ابزار ساخت  
├── build.sh                # اسکریپت بسته‌بندی دسته‌ای  
├── install.sh              # اسکریپت نصب یک‌باره  
└── config.example.json     # نمونه فایل پیکربندی  
```

### توابع اصلی

- `main()` - تابع اصلی، مدیریت اتصال و فراخوانی بارگذاری
- `uploadDirectory()` - بارگذاری بازگشتی پوشه
- `uploadFile()` - بارگذاری یک فایل منفرد
- `mkdirAll()` - ایجاد بازگشتی پوشه‌های راه دور

## مجوز

مجوز MIT

## مشارکت

ارسال Issue و Pull Request خوش‌آمدید!

---

Tranlated By [Open Ai Tx](https://github.com/OpenAiTx/OpenAiTx) | Last indexed: 2025-06-19

---