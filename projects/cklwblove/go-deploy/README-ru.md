# Go-Deploy инструмент для деплоя

Автоматизированный инструмент для деплоя, разработанный на языке Go, поддерживает загрузку локальных артефактов сборки на удалённый сервер по протоколу SFTP.

## Особенности

- ✅ **Безопасная передача**: Используется протокол SFTP, шифрование на базе SSH
- ✅ **Синхронизация директорий**: Рекурсивная загрузка всей структуры каталогов с сохранением иерархии файлов
- ✅ **Интеллектуальное создание**: Автоматическое создание структуры каталогов на удалённой стороне
- ✅ **Автоматическая адаптация путей**: Автоматический расчёт локального пути на основании расположения исполняемого файла, не требуется учитывать рабочую директорию
- ✅ **Поддержка конфигурационного файла**: Поддержка конфигурации в формате JSON, удобно для управления параметрами разных окружений
- ✅ **Исключение файлов**: Поддержка масок для исключения файлов из загрузки
- ✅ **Автоматическое резервное копирование**: Возможность создания резервных копий удалённых файлов перед загрузкой
- ✅ **Механизм повторных попыток**: Автоматический повтор загрузки при неудаче для повышения вероятности успеха
- ✅ **Детальная статистика**: Отображение количества загруженных файлов, объёма передачи, времени и скорости
- ✅ **Отображение прогресса**: Реальное отображение прогресса загрузки и информации о файлах
- ✅ **Обработка ошибок**: Продуманная обработка ошибок и вывод логов

## Системные требования

- Go 1.18 или выше
- Целевой сервер с поддержкой протоколов SSH/SFTP

## Инструкция по установке

### 1. Клонируйте проект

```bash
git clone <your-repo-url>
cd go-deploy
```

### 2. Инициализация Go-модуля

```bash
go mod init go-deploy
go mod tidy
```

### 3. Установка зависимостей

Программа автоматически загрузит следующие зависимости:

- `github.com/pkg/sftp` — SFTP-клиент
- `golang.org/x/crypto/ssh` — SSH-клиент

## Инструкция по настройке

Программа поддерживает два способа конфигурации:

### 1. Использование конфигурационного файла (рекомендуется)

Скопируйте `config.example.json` в `config.json` и измените параметры:

```bash
cp config.example.json config.json
```

Затем отредактируйте `config.json`:

```json
{
  "server": {
    "host": "your-server-ip",
    "port": 22,
    "username": "your-username",
    "password": "your-password",
    "timeout": 10
  },
  "paths": {
    "local": "../../unpackage/dist/build/web",
    "remote": "/opt/your-path/dist"
  },
  "options": {
    "backup": true,
    "backup_suffix": ".backup",
    "exclude_patterns": [
      "*.log",
      "*.map",
      ".DS_Store",
      "node_modules"
    ],
    "max_retries": 3,
    "chunk_size": 1048576
  }
}
```

#### Описание параметров

**server параметры**:

- `host`: адрес SSH-сервера
- `port`: порт SSH, обычно 22
- `username`: имя пользователя SSH
- `password`: пароль SSH (для продакшн рекомендуется использовать аутентификацию по ключу)
- `timeout`: таймаут соединения (в секундах)

**paths параметры**:

- `local`: путь к локальному каталогу, поддерживаются относительные и абсолютные пути
- `remote`: путь к удалённому каталогу, должен быть абсолютным

**options параметры**:

- `backup`: создавать ли резервную копию существующих удалённых файлов перед загрузкой
- `backup_suffix`: суффикс резервного файла, можно задать свой; если файла для резервирования нет, этап пропускается
- `exclude_patterns`: шаблоны для исключения файлов, поддерживаются маски
- `max_retries`: максимальное число попыток при неудачной загрузке
- `chunk_size`: размер блока передачи файла (в байтах, пока не реализовано)

### 2. Конфигурация по умолчанию (режим совместимости)

Если файл `config.json` отсутствует, программа использует встроенные параметры по умолчанию для обратной совместимости.

#### Приоритет конфигурационных файлов

1. **Файл, указанный в командной строке**: файл, указанный в параметре `--config`
2. **Файл по умолчанию**: `config.json` в текущей директории
3. **Встроенная конфигурация**: если нет ни одного из вышеперечисленных, используются параметры внутри программы

#### Правила обработки путей

- **Путь к конфигу**:
  - Относительный путь: относительно директории исполняемого файла
  - Абсолютный путь: используется напрямую
- **Путь к локальному каталогу**:
  - Относительный путь: относительно директории исполняемого файла
  - Абсолютный путь: используется напрямую

## Инструкция по запуску

### Параметры командной строки

Программа поддерживает следующие параметры командной строки:

```bash
# Показать справку
./deploy --help

# Показать информацию о версии  
./deploy --version

# Использовать конфиг по умолчанию config.json
./deploy

# Использовать указанный конфиг
./deploy --config prod.json

# Использовать абсолютный путь к конфигу
./deploy --config /path/to/config.json
```

### Запуск в режиме разработки

```bash
# Использовать конфиг по умолчанию
go run main.go

# Использовать указанный конфиг
go run main.go --config test.json

# Показать справку
go run main.go --help
```

### Запуск после компиляции

```bash
# Компиляция
go build -o deploy main.go

# Запуск с конфигом по умолчанию
./deploy

# Запуск с указанным конфигом
./deploy --config prod.json
```

## Инструкция по сборке

### 1. Сборка для локальной платформы

```bash
# Компиляция исполняемого файла для текущей платформы
go build -o deploy main.go
```

### 2. Кроссплатформенная сборка

#### Linux 64-бит

```bash
GOOS=linux GOARCH=amd64 go build -o deploy-linux-amd64 main.go
```

#### Windows 64-бит
```bash
GOOS=windows GOARCH=amd64 go build -o deploy-windows-amd64.exe main.go
```

#### macOS 64-бит

```bash
GOOS=darwin GOARCH=amd64 go build -o deploy-darwin-amd64 main.go
```

#### macOS ARM64 (M1/M2)

```bash
GOOS=darwin GOARCH=arm64 go build -o deploy-darwin-arm64 main.go
```

### 3. Оптимизация сборки (уменьшение размера файла)

```bash
# Удаление отладочной информации и таблицы символов
go build -ldflags="-s -w" -o deploy main.go

# Сжатие с помощью UPX (требуется предварительная установка UPX)
upx --best deploy
```

### 4. Скрипт пакетной сборки

Создайте скрипт `build.sh`:

```bash
#!/bin/bash

# Создать директорию для сборок
mkdir -p builds

# Сборка для разных платформ
echo "Сборка Linux 64-бит версии..."
GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o builds/deploy-linux-amd64 main.go

echo "Сборка Windows 64-бит версии..."
GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o builds/deploy-windows-amd64.exe main.go

echo "Сборка macOS 64-бит версии..."
GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o builds/deploy-darwin-amd64 main.go

echo "Сборка macOS ARM64 версии..."
GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o builds/deploy-darwin-arm64 main.go

echo "Сборка завершена!"
ls -la builds/
```

Запуск скрипта:

```bash
chmod +x build.sh
./build.sh
```

## Примеры использования

### Отобразить справку

```bash
$ ./deploy --help
Go-Deploy инструмент для деплоя

Использование: ./deploy [опции]

Опции:
  -config string
        Путь к файлу конфигурации (по умолчанию "config.json")
  -help
        Показать справку
  -version
        Показать информацию о версии

Примеры:
  ./deploy                           # Использовать файл конфигурации по умолчанию config.json
  ./deploy --config prod.json        # Использовать указанный файл конфигурации
  ./deploy --config /path/to/config.json  # Использовать абсолютный путь к файлу конфигурации
```

### Использование указанного файла конфигурации

```bash
$ ./deploy --config prod.json
Запуск программы деплоя...
Пробуем прочитать файл конфигурации: /path/to/go-deploy/prod.json
Используется файл конфигурации...
Локальная директория /path/to/project/dist существует
Подключение к SSH-серверу...
Подключение к SSH-серверу успешно
...
```

### Использование файла конфигурации

```bash
$ ./deploy
Запуск программы деплоя...
Пробуем прочитать файл конфигурации: /path/to/go-deploy/config.json
Используется файл конфигурации...
Локальная директория /path/to/project/unpackage/dist/build/web существует
Подключение к SSH-серверу...
Подключение к SSH-серверу успешно
Создание SFTP-клиента...
SFTP-клиент успешно создан
Подготовка к загрузке в удаленную директорию: /opt/xsoft/nginx/html/app/dist
Начинается загрузка директории...
Обход локальной директории: /path/to/project/unpackage/dist/build/web
Создание директории: /opt/xsoft/nginx/html/app/dist
Файл static/js/app.js.map исключён, пропуск загрузки
Создание резервной копии: /opt/xsoft/nginx/html/app/dist/index.html -> /opt/xsoft/nginx/html/app/dist/index.html.backup
Загрузка файла: /path/to/project/unpackage/dist/build/web/index.html -> /opt/xsoft/nginx/html/app/dist/index.html
Файл .DS_Store исключён, пропуск загрузки
Загрузка файла: /path/to/project/unpackage/dist/build/web/static/css/app.css -> /opt/xsoft/nginx/html/app/dist/static/css/app.css
Загрузка не удалась (попытка 1/3): ошибка сети
Повторная попытка загрузки файла (2/3): /path/to/project/unpackage/dist/build/web/static/js/app.js
Загрузка файла: /path/to/project/unpackage/dist/build/web/static/js/app.js -> /opt/xsoft/nginx/html/app/dist/static/js/app.js
...
Директория успешно загружена!
Статистика:
  - Количество загруженных файлов: 485
  - Количество созданных директорий: 18
  - Объём переданных данных: 25.8 MB
  - Время загрузки: 38.5s
  - Общее время: 39.2s
  - Скорость передачи: 0.67 MB/s
```

## Важные замечания

1. **Безопасность**:

   - В производственной среде рекомендуется использовать аутентификацию по SSH-ключу, а не по паролю
   - В данный момент используется `ssh.InsecureIgnoreHostKey()`, в продакшене необходимо проверять ключи хоста
2. **Сеть**:

   - Убедитесь, что локальная машина может подключиться к серверу по порту 22
   - Скорость передачи зависит от пропускной способности сети и производительности сервера
3. **Права**:

   - Убедитесь, что SSH-пользователь имеет права на запись в целевой директории
   - При необходимости используйте sudo-права
4. **Пути**:

   - Локальный путь автоматически вычисляется относительно расположения исполняемого файла, не требуется заботиться о рабочей директории
   - Удалённый путь задаётся как абсолютный

## Устранение неполадок

### Частые проблемы

1. **Таймаут подключения**

   ```
   Не удалось подключиться к SSH-серверу: dial tcp: i/o timeout
   ```

   - Проверьте адрес и порт сервера
   - Убедитесь в сетевой доступности
   - Проверьте настройки файрвола
2. **Ошибка аутентификации**

   ```
   Ошибка входа: ssh: handshake failed
   ```

   - Проверьте имя пользователя и пароль
   - Убедитесь, что SSH-сервис запущен
   - Проверьте конфигурацию SSH
3. **Ошибка прав доступа**

   ```
   Не удалось создать директорию: permission denied
   ```

   - Проверьте права пользователя на запись в целевой директории
   - Возможно, потребуется использовать sudo или изменить владельца директории
4. **Локальная директория не существует**

   ```
   Ошибка: локальная директория /path/to/unpackage/dist/build/web не существует
   ```

   - Убедитесь, что локальная сборка завершена
   - Проверьте структуру директорий проекта
   - Путь вычисляется автоматически, не требуется вручную менять рабочую директорию

## Примечания по разработке

### Структура проекта

```
go-deploy/
├── main.go                 # Главный файл программы
├── go.mod                  # Файл модуля Go  
├── go.sum                  # Файл проверки зависимостей
```
├── README.md               # Подробная документация
├── Makefile                # Инструмент сборки
├── build.sh                # Скрипт для пакетной сборки
├── install.sh              # Скрипт для установки в один клик
└── config.example.json     # Пример конфигурационного файла
```

### Основные функции

- `main()` - Главная функция, обрабатывает соединение и вызывает загрузку
- `uploadDirectory()` - Рекурсивная загрузка каталога
- `uploadFile()` - Загрузка отдельного файла
- `mkdirAll()` - Рекурсивное создание удалённого каталога

## Лицензия

MIT License

## Вклад

Приветствуются Issue и Pull Request!

---

Tranlated By [Open Ai Tx](https://github.com/OpenAiTx/OpenAiTx) | Last indexed: 2025-06-19

---